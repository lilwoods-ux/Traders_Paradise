{% extends 'base.html' %}
{% block content %}
<div class="row">
  {% for bot in bots %}
  <div class="col-md-4 mb-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">{{ bot.name }}</h5>
        <p class="card-text">Price: KES {{ bot.price }}</p>

        {% if request.user.is_authenticated %}
          {% if bot.id in purchased_bot_ids %}
            <a href="{{ bot.file.url }}" class="btn btn-success">Download</a>
          {% else %}
            <!-- Phone number input -->
            <input type="text" class="form-control mb-2 phone-input" placeholder="Enter phone number">

            <!-- Buy button -->
            <button class="btn btn-primary buy-btn"
        data-bot-id="{{ bot.id }}"
        data-bot-price="{{ bot.price }}">
        Buy Now
            </button>

          {% endif %}

          <!-- Delete option for authenticated users -->
          <a href="{% url 'delete_bot' bot.id %}" class="btn btn-danger mt-2">Delete</a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- JavaScript goes at the bottom of the page -->
<script>
document.querySelectorAll('.buy-btn').forEach(button => {
  button.addEventListener('click', () => {
    const botId = button.getAttribute('data-bot-id');
    const price = button.getAttribute('data-price');
    const phoneInput = button.parentElement.querySelector('.phone-input');
    const phone = phoneInput.value;

    if (!phone) {
      alert("Please enter your phone number.");
      return;
    }

    fetch('/bots/api/mpesa/stk-push/', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    bot_id: botId,
    amount: price,
    phone: phone
  })
})
.then(async response => {
  const contentType = response.headers.get("content-type");
  if (contentType && contentType.includes("application/json")) {
    const data = await response.json();
    alert(data.message || 'Payment attempted.');
  } else {
    const text = await response.text();
    console.error("Not JSON response:", text);
    alert("Server did not return JSON. Check the backend.");
  }
})
.catch(error => {
  alert('Network error: ' + error);
});

  });
});
</script>
{% endblock %}
