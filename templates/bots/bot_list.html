{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        {% for bot in bots %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary">{{ bot.name }}</h5>
                    <p class="card-text text-muted">Price: <strong>KES {{ bot.price }}</strong></p>

                    {% if user.is_authenticated %}
                        {% if bot.id in purchased_bot_ids %}
                            <a href="{{ bot.file.url }}" class="btn btn-success px-4">‚úÖ Download</a>
                        {% else %}
                            <button class="btn btn-primary buy-btn px-4" data-bot-id="{{ bot.id }}" data-bot-price="{{ bot.price }}">
                                üí∞ Buy Now
                            </button>
                        {% endif %}
                        <a href="{% url 'delete_bot' bot.id %}" class="btn btn-outline-danger mt-2">üóë Delete</a>
                    {% else %}
                        <a href="{% url 'login' %}" class="btn btn-outline-secondary mt-2">Login to Buy</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.querySelectorAll('.buy-btn').forEach(button => {
    button.addEventListener('click', () => {
        const botId = button.getAttribute('data-bot-id');
        const botPrice = button.getAttribute('data-bot-price');
        fetch('/bots/api/mpesa/stk-push/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ bot_id: botId, amount: botPrice })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Payment initiated. Please check your phone.');
            } else {
                alert('‚ö†Ô∏è Payment failed. ' + (data.message || 'Try again later.'));
            }
        })
        .catch(error => alert('‚ùå Error sending payment request.'));
    });
});
</script>
{% endblock %}
