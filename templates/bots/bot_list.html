{% extends 'base.html' %}
{% block content %}
<div class="row">
  {% for bot in bots %}
  <div class="col-md-4 mb-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">{{ bot.name }}</h5>
        <p class="card-text">Price: KES {{ bot.price }}</p>

        {% if request.user.is_authenticated %}
          {% if bot.id in purchased_bot_ids %}
            <a href="{{ bot.file.url }}" class="btn btn-success">Download</a>
          {% else %}
            <input type="text" class="form-control mb-2 phone-input" placeholder="Enter phone number">
            <button class="btn btn-primary buy-btn"
                    data-bot-id="{{ bot.id }}"
                    data-bot-price="{{ bot.price }}">
              Buy Now
            </button>
          {% endif %}
          <form action="{% url 'delete_bot' bot.id %}" method="post" class="mt-2">
            {% csrf_token %}
            <input type="password" name="password" placeholder="Password" class="form-control mb-1">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script>
document.querySelectorAll('.buy-btn').forEach(button => {
  button.addEventListener('click', () => {
    const botId = button.getAttribute('data-bot-id');
    const price = button.getAttribute('data-bot-price');
    const phoneInput = button.parentElement.querySelector('.phone-input');
    const phone = phoneInput.value;

    if (!phone) {
      alert("Please enter your phone number.");
      return;
    }

    fetch('/bots/api/mpesa/stk-push/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        bot_id: botId,
        amount: price,
        phone: phone
      })
    })
    .then(async response => {
      const contentType = response.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        const data = await response.json();
        alert(data.message || 'Payment attempted.');
        location.reload();
      } else {
        const text = await response.text();
        console.error("Non-JSON response:", text);
        alert("Server did not return JSON.");
      }
    })
    .catch(error => {
      alert('Network error: ' + error);
    });
  });
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
