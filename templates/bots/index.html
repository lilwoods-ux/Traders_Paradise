{% extends 'base.html' %}
{% block content %}
<div class="row">
    {% for bot in bots %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">{{ bot.name }}</h5>
                <p class="card-text">Price: KES {{ bot.price }}</p>
                {% if request.user.is_authenticated %}
                    {% if bot.id in purchased_bot_ids %}
                        <a href="{{ bot.file.url }}" class="btn btn-success">Download</a>
                    {% else %}
                        <button class="btn btn-primary buy-btn" data-bot-id="{{ bot.id }}">Buy Now</button>
                    {% endif %}
                {% endif %}
                {% if request.user.is_authenticated %}
                    <a href="{% url 'delete_bot' bot.id %}" class="btn btn-danger mt-2">Delete</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
<script>
document.querySelectorAll('.buy-btn').forEach(button => {
    button.addEventListener('click', () => {
        const botId = button.getAttribute('data-bot-id');
        fetch('/bots/api/mpesa/stk-push/', {  // Updated path to include /bots/
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bot_id: botId, amount: bot.price })  // Use bot's price
        }).then(response => response.json())
          .then(data => alert('STK Push sent! Check your phone.'))
          .catch(error => alert('Error initiating payment.'));
    });
});
</script>
{% endblock %}